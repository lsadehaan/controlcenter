<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/css/agent-details.css">
  <link rel="stylesheet" href="/css/agent-filewatcher.css">
  <link rel="stylesheet" href="/css/agent-configure.css">
</head>
<body data-agent-id="<%= agent.id %>" data-agent-config='<%- JSON.stringify(agent) %>' data-filewatcher-rules='<%- JSON.stringify(fileWatcherRules || []) %>'>
  <%- include('partials/nav') %>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2>Agent: <%= agent.id %></h2>
        <div>
          <span class="status-badge <%= agent.status %>"><%= agent.status %></span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab tab-btn active" data-tab="overview">Overview</button>
        <button class="tab tab-btn" data-tab="logs">Logs</button>
        <button class="tab tab-btn" data-tab="workflows">Workflows</button>
        <button class="tab tab-btn" data-tab="metrics">Metrics</button>
        <button class="tab tab-btn" data-tab="files">Files</button>
        <button class="tab tab-btn" data-tab="filewatcher">File Watchers</button>
        <button class="tab tab-btn" data-tab="configure">Configure</button>
        <button class="tab tab-btn" data-tab="about">About</button>
      </div>

      <!-- Overview Tab -->
      <div id="overview-tab" class="tab-content active">
        <!-- Agent Commands -->
        <div class="metric-card" style="margin-bottom: 20px;">
          <h4>Agent Commands</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
            <button class="btn command-btn" data-command="reload-config">Reload Config</button>
            <button class="btn command-btn" data-command="git-pull">Git Pull</button>
            <button class="btn command-btn" data-command="reload-filewatcher">Reload File Watcher</button>
          </div>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Log Level:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="log-level-select" class="form-control" style="max-width: 150px;">
                <option value="debug">Debug</option>
                <option value="info" selected>Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
              </select>
              <button id="set-log-level-btn" class="btn">Set Log Level</button>
            </div>
          </div>
          <div id="command-result" style="margin-top: 10px; padding: 10px; display: none; border-radius: 4px;"></div>
        </div>

        <div class="metric-card">
          <h4>Agent Information</h4>
          <div class="metric-row">
            <span>Agent ID:</span>
            <strong><%= agent.id %></strong>
          </div>
          <div class="metric-row">
            <span>Hostname:</span>
            <strong><%= agent.hostname || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>Platform:</span>
            <strong><%= agent.platform || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>Status:</span>
            <strong><%= agent.status %></strong>
          </div>
          <div class="metric-row">
            <span>Last Heartbeat:</span>
            <strong><%= agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'Never' %></strong>
          </div>
          <div class="metric-row">
            <span>Registered:</span>
            <strong><%= agent.registered_at ? new Date(agent.registered_at).toLocaleString() : 'N/A' %></strong>
          </div>
        </div>

        <div class="metric-card">
          <h4>API Configuration</h4>
          <div class="metric-row">
            <span>Connection IP:</span>
            <strong><%= agent.metadata?.connectionIp || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>API Address:</span>
            <strong id="current-api-address"><%= agent.metadata?.apiAddress || 'Auto-detect from connection IP' %></strong>
          </div>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Update API Address:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" id="new-api-address" class="form-control" placeholder="e.g., 192.168.1.100:8088" style="flex: 1;">
              <button id="update-api-address-btn" class="btn">Update</button>
              <button id="clear-api-address-btn" class="btn">Clear (Auto-detect)</button>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">
              Leave empty or click Clear to auto-detect from connection IP. Format: host:port (do not include http://)
            </small>
          </div>
          <div id="api-update-result" style="margin-top: 10px; padding: 10px; display: none; border-radius: 4px;"></div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs-tab" class="tab-content">
        <div class="log-controls">
          <input type="text" id="log-search" placeholder="Search logs..." style="flex: 1; min-width: 200px;">
          <select id="log-level">
            <option value="">All Levels</option>
            <option value="debug">Debug</option>
            <option value="info">Info</option>
            <option value="warn">Warning</option>
            <option value="error">Error</option>
          </select>
          <select id="log-page-size">
            <option value="50">50 lines</option>
            <option value="100" selected>100 lines</option>
            <option value="200">200 lines</option>
            <option value="500">500 lines</option>
          </select>
          <button id="load-logs-btn" class="btn">Refresh</button>
          <button id="download-logs-btn" class="btn">Download</button>
        </div>

        <div class="log-viewer" id="log-viewer">
          <div style="text-align: center; color: #858585;">
            Click "Refresh" to load logs from agent
          </div>
        </div>

        <div class="pagination" id="log-pagination" style="display: none;">
          <button class="btn" id="prev-btn">Previous</button>
          <span id="page-info">Page 1 of 1</span>
          <button class="btn" id="next-btn">Next</button>
        </div>
      </div>

      <!-- Workflows Tab -->
      <div id="workflows-tab" class="tab-content">
        <!-- Deployed Workflows Section -->
        <div class="metric-card" style="margin-bottom: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Deployed Workflows</h3>
            <button id="load-deployed-workflows-btn" class="btn">🔄 Refresh</button>
          </div>
          <div id="deployed-workflows-content">
            <p style="color: #666;">Click "Refresh" to view workflows deployed to this agent</p>
          </div>
        </div>

        <!-- Workflow Executions Section -->
        <h3>Workflow Executions</h3>

        <!-- Control Bar -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; gap: 10px; align-items: center;">
            <button id="load-workflow-executions-btn" class="btn">🔄 Refresh</button>
            <div class="auto-refresh-control">
              <input type="checkbox" id="auto-refresh-toggle">
              <label for="auto-refresh-toggle">Auto-refresh</label>
              <select id="auto-refresh-interval" style="padding: 4px 8px; font-size: 13px;" disabled>
                <option value="5000">5s</option>
                <option value="10000" selected>10s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
              </select>
            </div>
          </div>
          <div class="view-toggle">
            <button class="view-mode-btn active" data-view-mode="compact">Compact</button>
            <button class="view-mode-btn" data-view-mode="detailed">Detailed</button>
          </div>
        </div>

        <!-- Filters -->
        <div class="execution-filters">
          <select id="filter-workflow">
            <option value="">All Workflows</option>
          </select>
          <select id="filter-status">
            <option value="">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
            <option value="running">Running</option>
          </select>
          <select id="filter-date">
            <option value="all">All Time</option>
            <option value="1h">Last Hour</option>
            <option value="24h">Last 24 Hours</option>
            <option value="7d" selected>Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
          </select>
          <input type="text" id="filter-search" placeholder="Search errors, context..." style="flex: 1; min-width: 200px;">
          <select id="sort-by">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="duration-desc">Longest Duration</option>
            <option value="duration-asc">Shortest Duration</option>
          </select>
        </div>

        <!-- Statistics -->
        <div class="execution-stats" id="execution-stats" style="display: none;">
          <div class="stat">
            <span>📊 Total:</span>
            <span class="stat-value" id="stat-total">0</span>
          </div>
          <div class="stat">
            <span>✅ Success:</span>
            <span class="stat-value" style="color: #28a745;" id="stat-success">0</span>
          </div>
          <div class="stat">
            <span>❌ Failed:</span>
            <span class="stat-value" style="color: #dc3545;" id="stat-failed">0</span>
          </div>
          <div class="stat">
            <span>⏱️ Avg Duration:</span>
            <span class="stat-value" id="stat-avg-duration">0s</span>
          </div>
          <div class="stat">
            <span>📈 Success Rate:</span>
            <span class="stat-value" id="stat-success-rate">0%</span>
          </div>
        </div>

        <!-- Executions List -->
        <div id="workflow-executions">
          <p style="color: #666;">Click "Refresh" to view workflow execution history</p>
        </div>

        <!-- Pagination -->
        <div class="execution-pagination" id="execution-pagination" style="display: none;">
          <div>
            <button class="btn" id="exec-prev-btn">← Previous</button>
            <button class="btn" id="exec-next-btn">Next →</button>
          </div>
          <div id="exec-page-info" style="font-size: 13px; color: #666;">Page 1 of 1</div>
          <div>
            <select id="exec-page-size" style="padding: 6px 10px; font-size: 13px;">
              <option value="10" selected>10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Metrics Tab -->
      <div id="metrics-tab" class="tab-content">
        <button id="load-metrics-btn" class="btn" style="margin-bottom: 15px;">Refresh Metrics</button>
        <div id="metrics-content">
          <p style="color: #666;">Click "Refresh Metrics" to load agent metrics</p>
        </div>
      </div>

      <!-- Files Tab -->
      <div id="files-tab" class="tab-content">
        <div style="margin-bottom: 15px;">
          <h3>File Browser</h3>
          <p style="color: #666; font-size: 14px;">Browse, download, upload, and manage files on the agent.</p>
        </div>

        <!-- Path selector -->
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Path:</label>
          <select id="path-selector" class="form-control" style="max-width: 500px;">
            <option value="">Select a path to browse...</option>
          </select>
        </div>

        <!-- File browser controls -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
          <button id="refresh-current-path-btn" class="btn">🔄 Refresh</button>
          <button id="show-upload-dialog-btn" class="btn">📤 Upload File</button>
          <button id="show-create-folder-dialog-btn" class="btn">📁 New Folder</button>
          <div style="flex: 1;"></div>
          <div id="file-browser-status" style="font-size: 13px; color: #666;"></div>
        </div>

        <!-- Breadcrumb navigation -->
        <div id="breadcrumb" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; display: none;">
          <span style="color: #666;">Path:</span>
          <span id="breadcrumb-path"></span>
        </div>

        <!-- File browser content -->
        <div id="file-browser-content">
          <p style="color: #666;">Select a path from the dropdown above to browse files on the agent</p>
        </div>

        <!-- Upload dialog (hidden by default) -->
        <div id="upload-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-top: 0;">Upload File</h3>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px;">Destination Path:</label>
              <input type="text" id="upload-path" class="form-control" readonly style="background: #e9ecef;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px;">Select File:</label>
              <input type="file" id="upload-file-input" class="form-control">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="hide-upload-dialog-btn" class="btn">Cancel</button>
              <button id="perform-upload-btn" class="btn" style="background: #007bff; color: white;">Upload</button>
            </div>
            <div id="upload-progress" style="margin-top: 15px; display: none;">
              <div style="background: #e9ecef; border-radius: 4px; overflow: hidden;">
                <div id="upload-progress-bar" style="background: #007bff; height: 30px; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Create folder dialog (hidden by default) -->
        <div id="create-folder-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-top: 0;">Create Folder</h3>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px;">Parent Path:</label>
              <input type="text" id="create-folder-parent" class="form-control" readonly style="background: #e9ecef;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px;">Folder Name:</label>
              <input type="text" id="create-folder-name" class="form-control" placeholder="New Folder">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button id="hide-create-folder-dialog-btn" class="btn">Cancel</button>
              <button id="perform-create-folder-btn" class="btn" style="background: #007bff; color: white;">Create</button>
            </div>
          </div>
        </div>
      </div>

      <!-- File Watcher Tab -->
      <div id="filewatcher-tab" class="tab-content">
        <div class="filewatcher-container">
          <!-- Global Settings Section -->
          <div class="import-section" style="margin-bottom: 20px;">
            <h3>Global File Watcher Settings</h3>
            <p>These settings apply to all pattern-based file watcher rules</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Root Scan Directory</label>
                <input type="text" id="global-scan-dir" class="form-input" placeholder="e.g., \\192.168.9.36\Connect or C:\Watch" style="width: 100%;">
                <small style="color: #666;">Base directory for pattern-mode rules</small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                  <input type="checkbox" id="global-scan-subdir" style="margin-right: 5px;">
                  Recursive Watch (ScanSubDir)
                </label>
                <small style="color: #666;">When enabled, watches matched directories and all their subdirectories</small>
              </div>
            </div>
            <button class="btn btn-primary" id="save-global-settings-btn" style="margin-top: 15px;">Save Global Settings</button>
          </div>

          <!-- Import Section -->
          <div class="import-section">
            <h3>Import Configuration</h3>
            <p>Import file watcher rules from an existing INI configuration file</p>
            <input type="file" id="import-file" accept=".ini" style="display: none;">
            <button class="btn btn-primary" id="import-ini-btn">
              Import INI File
            </button>
          </div>

          <!-- Toolbar -->
          <div class="rules-toolbar">
            <div>
              <button class="btn btn-primary" id="create-rule-btn">
                <span style="margin-right: 5px;">➕</span> New Rule
              </button>
              <button class="btn" id="export-rules-btn">
                <span style="margin-right: 5px;">📥</span> Export Rules
              </button>
            </div>
            <div>
              <span id="rule-count">0 rules</span>
            </div>
          </div>

          <!-- Rules List -->
          <div class="rules-list" id="rules-list">
            <!-- Rules will be populated here -->
          </div>
        </div>

        <!-- Rule Editor Modal -->
        <div id="rule-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="modal-title">New File Watcher Rule</h3>
              <button class="btn btn-sm" id="close-modal-header-btn">&times;</button>
            </div>

            <div class="modal-body">
              <!-- Tabs -->
              <div class="form-tabs">
                <button class="form-tab active" data-tab="matching">Matching</button>
                <button class="form-tab" data-tab="operations">Operations</button>
                <button class="form-tab" data-tab="timing">Timing</button>
                <button class="form-tab" data-tab="advanced">Advanced</button>
              </div>

              <!-- Tab Contents -->
              <div id="matching-tab" class="tab-content active">
                <div class="form-group">
                  <label>Rule Name *</label>
                  <input type="text" id="rule-name" class="form-input" placeholder="e.g., Process Invoice Files">
                </div>

                <div class="form-group">
                  <label>Description</label>
                  <textarea id="rule-description" class="form-input" rows="2" placeholder="Optional description"></textarea>
                </div>

                <div class="form-group">
                  <label>
                    <input type="checkbox" id="rule-enabled" class="form-checkbox" checked>
                    Enabled
                  </label>
                </div>

                <div class="form-group">
                  <label>Watch Mode</label>
                  <select id="watch-mode" class="form-input">
                    <option value="absolute">Absolute Path (Direct folder specification)</option>
                    <option value="pattern">Pattern Mode (Use global ScanDir + regex)</option>
                  </select>
                  <div class="regex-helper">Pattern mode uses the global ScanDir as base and matches subdirectories</div>
                </div>

                <div class="form-group">
                  <label id="dir-regex-label">Directory Path/Pattern</label>
                  <input type="text" id="dir-regex" class="form-input" placeholder="e.g., C:\\Watch or (?i)\\Invoices\\Input$">
                  <div class="regex-helper" id="dir-regex-helper">In absolute mode: full path; In pattern mode: regex to match under ScanDir</div>
                </div>

                <div class="form-group">
                  <label>File Regex Pattern</label>
                  <input type="text" id="file-regex" class="form-input" placeholder="e.g., (?i)^INV.*\.pdf$">
                  <div class="regex-helper">^ = start, $ = end, .* = any characters</div>
                </div>

                <div class="form-group">
                  <label>Content Regex Pattern (Optional)</label>
                  <input type="text" id="content-regex" class="form-input" placeholder="e.g., INVOICE|RECEIPT">
                  <div class="regex-helper">Match content within the file</div>
                </div>
              </div>

              <div id="operations-tab" class="tab-content">
                <div class="form-grid">
                  <div class="form-group">
                    <label>Copy/Move To Directory</label>
                    <input type="text" id="copy-to-dir" class="form-input" placeholder="e.g., C:\\Processed">
                  </div>

                  <div class="form-group">
                    <label>Operation Type</label>
                    <select id="copy-option" class="form-input">
                      <option value="21">Move File</option>
                      <option value="22">Copy File</option>
                    </select>
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>Rename File To</label>
                    <input type="text" id="rename-to" class="form-input" placeholder="e.g., PROCESSED_{filename}">
                    <div class="regex-helper">Variables: {filename}, {name}, {ext}, {timestamp}</div>
                  </div>

                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="insert-timestamp" class="form-checkbox">
                      Insert Timestamp
                    </label>
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>Backup To Directory</label>
                    <input type="text" id="backup-dir" class="form-input" placeholder="e.g., C:\\Backup">
                  </div>

                  <div class="form-group">
                    <label>Temp Extension</label>
                    <input type="text" id="temp-ext" class="form-input" placeholder="e.g., .tmp">
                  </div>
                </div>

                <div class="form-grid">
                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="remove-after" class="form-checkbox" checked>
                      Remove After Copy
                    </label>
                  </div>

                  <div class="form-group">
                    <label>
                      <input type="checkbox" id="overwrite" class="form-checkbox" checked>
                      Overwrite Existing Files
                    </label>
                  </div>
                </div>

                <h4 style="margin-top: 20px;">External Programs</h4>

                <div class="form-group">
                  <label>
                    Execute Before Processing
                    <input type="checkbox" id="exec-before-workflow" style="margin-left: 10px;" data-field-prefix="exec-before">
                    <span style="font-size: 12px; margin-left: 5px;">Use Workflow</span>
                  </label>
                  <input type="text" id="exec-before" class="form-input" placeholder="e.g., echo 'processing' >> {file}" style="display: block;">
                  <select id="exec-before-select" class="form-input" style="display: none;">
                    <option value="">-- Select Workflow --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>
                    Execute After Processing
                    <input type="checkbox" id="exec-after-workflow" style="margin-left: 10px;" data-field-prefix="exec-after">
                    <span style="font-size: 12px; margin-left: 5px;">Use Workflow</span>
                  </label>
                  <input type="text" id="exec-after" class="form-input" placeholder="e.g., /usr/bin/notify-send 'File processed'" style="display: block;">
                  <select id="exec-after-select" class="form-input" style="display: none;">
                    <option value="">-- Select Workflow --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>
                    Execute On Error
                    <input type="checkbox" id="exec-error-workflow" style="margin-left: 10px;" data-field-prefix="exec-error">
                    <span style="font-size: 12px; margin-left: 5px;">Use Workflow</span>
                  </label>
                  <input type="text" id="exec-error" class="form-input" placeholder="e.g., mv {file} /error/folder/" style="display: block;">
                  <select id="exec-error-select" class="form-input" style="display: none;">
                    <option value="">-- Select Workflow --</option>
                  </select>
                </div>
              </div>

              <div id="timing-tab" class="tab-content">
                <h4>Time Window</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label>Start Time</label>
                    <div style="display: flex; gap: 10px;">
                      <input type="number" id="start-hour" class="form-input" min="0" max="23" value="0" style="width: 60px;"> :
                      <input type="number" id="start-minute" class="form-input" min="0" max="59" value="0" style="width: 60px;">
                    </div>
                  </div>

                  <div class="form-group">
                    <label>End Time</label>
                    <div style="display: flex; gap: 10px;">
                      <input type="number" id="end-hour" class="form-input" min="0" max="23" value="23" style="width: 60px;"> :
                      <input type="number" id="end-minute" class="form-input" min="0" max="59" value="59" style="width: 60px;">
                    </div>
                  </div>
                </div>

                <h4 style="margin-top: 20px;">Days of Week</h4>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                  <label><input type="checkbox" class="weekday" value="1" checked> Sunday</label>
                  <label><input type="checkbox" class="weekday" value="2" checked> Monday</label>
                  <label><input type="checkbox" class="weekday" value="4" checked> Tuesday</label>
                  <label><input type="checkbox" class="weekday" value="8" checked> Wednesday</label>
                  <label><input type="checkbox" class="weekday" value="16" checked> Thursday</label>
                  <label><input type="checkbox" class="weekday" value="32" checked> Friday</label>
                  <label><input type="checkbox" class="weekday" value="64" checked> Saturday</label>
                </div>

                <h4 style="margin-top: 20px;">Processing Delays</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label>Process After (seconds)</label>
                    <input type="number" id="process-after" class="form-input" min="0" value="0">
                    <div class="regex-helper">Wait before processing detected file</div>
                  </div>

                  <div class="form-group">
                    <label>Delay Between Files (ms)</label>
                    <input type="number" id="delay-next" class="form-input" min="0" value="0">
                    <div class="regex-helper">Delay before processing next file</div>
                  </div>
                </div>
              </div>

              <div id="advanced-tab" class="tab-content">
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="check-in-use" class="form-checkbox" checked>
                    Check if File is In Use
                  </label>
                  <div class="regex-helper">Skip files that are still being written</div>
                </div>

                <!-- Note: scanSubDir is now a global setting -->

                <div class="form-grid">
                  <div class="form-group">
                    <label>Max Retries</label>
                    <input type="number" id="max-retries" class="form-input" min="0" value="5">
                  </div>

                  <div class="form-group">
                    <label>Retry Delay (ms)</label>
                    <input type="number" id="retry-delay" class="form-input" min="0" value="1000">
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn" id="close-modal-footer-btn">Cancel</button>
              <button class="btn btn-primary" id="save-rule-btn">Save Rule</button>
            </div>
          </div>
        </div>
      </div>

      <!-- About Tab -->
      <div id="about-tab" class="tab-content">
        <div class="metric-card">
          <h4>Agent Information</h4>
          <div id="agent-about-content">
            <p style="color: #666;">Loading agent information...</p>
          </div>
        </div>
      </div>

      <!-- Configure Tab -->
      <div id="configure-tab" class="tab-content">
        <form class="config-form" id="config-form">
          <div class="form-section">
            <h3>Basic Settings</h3>
            <div class="form-group">
              <label>Agent ID</label>
              <input type="text" class="form-input" value="<%= agent.id %>" disabled>
            </div>
            <div class="form-group">
              <label>Hostname</label>
              <input type="text" class="form-input" value="<%= agent.metadata?.hostname || '' %>" disabled>
            </div>
          </div>

          <div class="form-section">
            <h3>SSH Server Configuration</h3>
            <div class="form-group">
              <label>SSH Server Port</label>
              <input type="number" id="sshServerPort" class="form-input"
                     value="<%= agent.config.sshServerPort || 2222 %>" min="1" max="65535">
            </div>
            <div class="form-group">
              <label>Authorized SSH Keys</label>
              <div id="ssh-keys" class="ssh-key-list">
                <% const authorizedKeys = agent.config.authorizedSSHKeys || []; %>
                <% if (authorizedKeys.length === 0) { %>
                  <p style="color: #999;">No authorized keys configured</p>
                <% } else { %>
                  <% authorizedKeys.forEach((key, index) => { %>
                    <div class="ssh-key-item">
                      <input type="text" class="form-input" value="<%= key %>" data-index="<%= index %>">
                      <button type="button" class="btn btn-sm btn-danger remove-ssh-key-btn" data-index="<%= index %>">Remove</button>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              <button type="button" class="btn btn-sm add-key-btn" id="add-ssh-key-btn">Add SSH Key</button>
            </div>
          </div>

          <div class="form-section">
            <h3>Deployed Workflows</h3>
            <% const workflows = agent.config.workflows || []; %>
            <% if (workflows.length === 0) { %>
              <p style="color: #999;">No workflows deployed to this agent</p>
            <% } else { %>
              <ul class="workflow-list">
                <% workflows.forEach(workflow => { %>
                  <li class="workflow-item">
                    <div>
                      <strong><%= workflow.name %></strong>
                      <span style="color: #666; margin-left: 10px;">ID: <%= workflow.id %></span>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-workflow-btn"
                            data-workflow-id="<%= workflow.id %>">Remove</button>
                  </li>
                <% }) %>
              </ul>
            <% } %>
            <a href="/workflows" class="btn btn-sm">Deploy Workflows</a>
          </div>

          <div class="form-section">
            <h3>File Browser Settings</h3>
            <div class="form-group">
              <label>
                <input type="checkbox" id="fileBrowserEnabled"
                       <% if (agent.config.fileBrowserSettings?.enabled) { %>checked<% } %>>
                Enable File Browser
              </label>
              <p style="color: #666; font-size: 13px; margin-top: 5px;">
                Allows browsing, downloading, and uploading files on this agent through the manager UI.
              </p>
            </div>
            <div class="form-group">
              <label>Allowed Paths</label>
              <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                Whitelist of directories accessible via file browser. If empty, defaults to agent data directory only.
              </p>
              <div id="allowed-paths" class="ssh-key-list">
                <% const allowedPaths = agent.config.fileBrowserSettings?.allowedPaths || []; %>
                <% if (allowedPaths.length === 0) { %>
                  <p style="color: #999;">No paths configured (agent data directory only)</p>
                <% } else { %>
                  <% allowedPaths.forEach((path, index) => { %>
                    <div class="ssh-key-item">
                      <input type="text" class="form-input" value="<%= path %>" data-path-index="<%= index %>">
                      <button type="button" class="btn btn-sm btn-danger remove-path-btn" data-path-index="<%= index %>">Remove</button>
                    </div>
                  <% }) %>
                <% } %>
              </div>
              <button type="button" class="btn btn-sm add-key-btn" id="add-path-btn">Add Path</button>
            </div>
            <div class="form-group">
              <label>Max Upload Size (bytes)</label>
              <input type="number" id="maxUploadSize" class="form-input"
                     value="<%= agent.config.fileBrowserSettings?.maxUploadSize || 104857600 %>"
                     min="1" placeholder="104857600">
              <p style="color: #666; font-size: 13px; margin-top: 5px;">
                Default: 104857600 (100MB)
              </p>
            </div>
            <div class="form-group">
              <label>Max List Items</label>
              <input type="number" id="maxListItems" class="form-input"
                     value="<%= agent.config.fileBrowserSettings?.maxListItems || 1000 %>"
                     min="1" placeholder="1000">
              <p style="color: #666; font-size: 13px; margin-top: 5px;">
                Maximum number of files/folders to show per directory. Default: 1000
              </p>
            </div>
          </div>

          <div class="form-section">
            <h3>Advanced Configuration</h3>
            <div class="form-group">
              <label>Config Repository Path</label>
              <input type="text" id="configRepoPath" class="form-input"
                     value="<%= agent.config.configRepoPath || '' %>"
                     placeholder="e.g., /path/to/config/repo">
            </div>
            <div class="form-group">
              <label>Custom Configuration (JSON)</label>
              <textarea id="customConfig" class="form-input"
                        placeholder='{"key": "value"}'><%- JSON.stringify(agent.config.custom || {}, null, 2) %></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Configuration</button>
          </div>
        </form>
      </div>

    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="/js/agent-details.js?v=<%= Date.now() %>"></script>
  <script src="/js/agent-filewatcher.js?v=<%= Date.now() %>"></script>
  <script src="/js/agent-configure.js?v=<%= Date.now() %>"></script>
</body>
</html>
