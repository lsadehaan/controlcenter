<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
</head>
<body data-agent-id="<%= agent.id %>" data-agent-config='<%- JSON.stringify(agent) %>'>
  <%- include('partials/nav') %>

  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2>Agent: <%= agent.id %></h2>
        <div>
          <span class="status-badge <%= agent.status %>"><%= agent.status %></span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Overview</button>
        <button class="tab" onclick="switchTab('logs')">Logs</button>
        <button class="tab" onclick="switchTab('workflows')">Workflows</button>
        <button class="tab" onclick="switchTab('metrics')">Metrics</button>
        <button class="tab" onclick="switchTab('files')">Files</button>
        <a href="/agents/<%= agent.id %>/filewatcher" class="tab" style="text-decoration: none;">File Watchers</a>
        <a href="/agents/<%= agent.id %>/configure" class="tab" style="text-decoration: none;">Configure</a>
      </div>

      <!-- Overview Tab -->
      <div id="overview-tab" class="tab-content active">
        <!-- Agent Commands -->
        <div class="metric-card" style="margin-bottom: 20px;">
          <h4>Agent Commands</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
            <button class="btn" onclick="sendCommand('reload-config')">Reload Config</button>
            <button class="btn" onclick="sendCommand('git-pull')">Git Pull</button>
            <button class="btn" onclick="sendCommand('reload-filewatcher')">Reload File Watcher</button>
          </div>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Log Level:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="log-level-select" class="form-control" style="max-width: 150px;">
                <option value="debug">Debug</option>
                <option value="info" selected>Info</option>
                <option value="warn">Warning</option>
                <option value="error">Error</option>
              </select>
              <button class="btn" onclick="setLogLevel()">Set Log Level</button>
            </div>
          </div>
          <div id="command-result" style="margin-top: 10px; padding: 10px; display: none; border-radius: 4px;"></div>
        </div>

        <div class="metric-card">
          <h4>Agent Information</h4>
          <div class="metric-row">
            <span>Agent ID:</span>
            <strong><%= agent.id %></strong>
          </div>
          <div class="metric-row">
            <span>Hostname:</span>
            <strong><%= agent.hostname || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>Platform:</span>
            <strong><%= agent.platform || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>Status:</span>
            <strong><%= agent.status %></strong>
          </div>
          <div class="metric-row">
            <span>Last Heartbeat:</span>
            <strong><%= agent.last_heartbeat ? new Date(agent.last_heartbeat).toLocaleString() : 'Never' %></strong>
          </div>
          <div class="metric-row">
            <span>Registered:</span>
            <strong><%= agent.registered_at ? new Date(agent.registered_at).toLocaleString() : 'N/A' %></strong>
          </div>
        </div>

        <div class="metric-card">
          <h4>API Configuration</h4>
          <div class="metric-row">
            <span>Connection IP:</span>
            <strong><%= agent.metadata?.connectionIp || 'N/A' %></strong>
          </div>
          <div class="metric-row">
            <span>API Address:</span>
            <strong id="current-api-address"><%= agent.metadata?.apiAddress || 'Auto-detect from connection IP' %></strong>
          </div>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Update API Address:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" id="new-api-address" class="form-control" placeholder="e.g., 192.168.1.100:8088" style="flex: 1;">
              <button class="btn" onclick="updateApiAddress()">Update</button>
              <button class="btn" onclick="clearApiAddress()">Clear (Auto-detect)</button>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">
              Leave empty or click Clear to auto-detect from connection IP. Format: host:port (do not include http://)
            </small>
          </div>
          <div id="api-update-result" style="margin-top: 10px; padding: 10px; display: none; border-radius: 4px;"></div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logs-tab" class="tab-content">
        <div class="log-controls">
          <input type="text" id="log-search" placeholder="Search logs..." style="flex: 1; min-width: 200px;">
          <select id="log-level">
            <option value="">All Levels</option>
            <option value="debug">Debug</option>
            <option value="info">Info</option>
            <option value="warn">Warning</option>
            <option value="error">Error</option>
          </select>
          <select id="log-page-size">
            <option value="50">50 lines</option>
            <option value="100" selected>100 lines</option>
            <option value="200">200 lines</option>
            <option value="500">500 lines</option>
          </select>
          <button class="btn" onclick="loadLogs()">Refresh</button>
          <button class="btn" onclick="downloadLogs()">Download</button>
        </div>

        <div class="log-viewer" id="log-viewer">
          <div style="text-align: center; color: #858585;">
            Click "Refresh" to load logs from agent
          </div>
        </div>

        <div class="pagination" id="log-pagination" style="display: none;">
          <button class="btn" onclick="prevPage()" id="prev-btn">Previous</button>
          <span id="page-info">Page 1 of 1</span>
          <button class="btn" onclick="nextPage()" id="next-btn">Next</button>
        </div>
      </div>

      <!-- Workflows Tab -->
      <div id="workflows-tab" class="tab-content">
        <h3>Workflow Executions</h3>

        <!-- Control Bar -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn" onclick="loadWorkflowExecutions()">üîÑ Refresh</button>
            <div class="auto-refresh-control">
              <input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()">
              <label for="auto-refresh-toggle">Auto-refresh</label>
              <select id="auto-refresh-interval" style="padding: 4px 8px; font-size: 13px;" disabled>
                <option value="5000">5s</option>
                <option value="10000" selected>10s</option>
                <option value="30000">30s</option>
                <option value="60000">60s</option>
              </select>
            </div>
          </div>
          <div class="view-toggle">
            <button class="active" onclick="setViewMode('compact')">Compact</button>
            <button onclick="setViewMode('detailed')">Detailed</button>
          </div>
        </div>

        <!-- Filters -->
        <div class="execution-filters">
          <select id="filter-workflow" onchange="applyFilters()">
            <option value="">All Workflows</option>
          </select>
          <select id="filter-status" onchange="applyFilters()">
            <option value="">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
            <option value="running">Running</option>
          </select>
          <select id="filter-date" onchange="applyFilters()">
            <option value="all">All Time</option>
            <option value="1h">Last Hour</option>
            <option value="24h">Last 24 Hours</option>
            <option value="7d" selected>Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
          </select>
          <input type="text" id="filter-search" placeholder="Search errors, context..." onkeyup="applyFilters()" style="flex: 1; min-width: 200px;">
          <select id="sort-by" onchange="applyFilters()">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="duration-desc">Longest Duration</option>
            <option value="duration-asc">Shortest Duration</option>
          </select>
        </div>

        <!-- Statistics -->
        <div class="execution-stats" id="execution-stats" style="display: none;">
          <div class="stat">
            <span>üìä Total:</span>
            <span class="stat-value" id="stat-total">0</span>
          </div>
          <div class="stat">
            <span>‚úÖ Success:</span>
            <span class="stat-value" style="color: #28a745;" id="stat-success">0</span>
          </div>
          <div class="stat">
            <span>‚ùå Failed:</span>
            <span class="stat-value" style="color: #dc3545;" id="stat-failed">0</span>
          </div>
          <div class="stat">
            <span>‚è±Ô∏è Avg Duration:</span>
            <span class="stat-value" id="stat-avg-duration">0s</span>
          </div>
          <div class="stat">
            <span>üìà Success Rate:</span>
            <span class="stat-value" id="stat-success-rate">0%</span>
          </div>
        </div>

        <!-- Executions List -->
        <div id="workflow-executions">
          <p style="color: #666;">Click "Refresh" to view workflow execution history</p>
        </div>

        <!-- Pagination -->
        <div class="execution-pagination" id="execution-pagination" style="display: none;">
          <div>
            <button class="btn" onclick="prevExecutionPage()" id="exec-prev-btn">‚Üê Previous</button>
            <button class="btn" onclick="nextExecutionPage()" id="exec-next-btn">Next ‚Üí</button>
          </div>
          <div id="exec-page-info" style="font-size: 13px; color: #666;">Page 1 of 1</div>
          <div>
            <select id="exec-page-size" onchange="changePageSize()" style="padding: 6px 10px; font-size: 13px;">
              <option value="10" selected>10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Metrics Tab -->
      <div id="metrics-tab" class="tab-content">
        <button class="btn" onclick="loadMetrics()" style="margin-bottom: 15px;">Refresh Metrics</button>
        <div id="metrics-content">
          <p style="color: #666;">Click "Refresh Metrics" to load agent metrics</p>
        </div>
      </div>

      <!-- Files Tab -->
      <div id="files-tab" class="tab-content">
        <div style="margin-bottom: 15px;">
          <h3>File Browser</h3>
          <p style="color: #666; font-size: 14px;">Browse, download, upload, and manage files on the agent.</p>
        </div>

        <!-- Path selector -->
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 500;">Select Path:</label>
          <select id="path-selector" class="form-control" onchange="onPathSelected()" style="max-width: 500px;">
            <option value="">Select a path to browse...</option>
          </select>
        </div>

        <!-- File browser controls -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
          <button class="btn" onclick="refreshCurrentPath()">üîÑ Refresh</button>
          <button class="btn" onclick="showUploadDialog()">üì§ Upload File</button>
          <button class="btn" onclick="showCreateFolderDialog()">üìÅ New Folder</button>
          <div style="flex: 1;"></div>
          <div id="file-browser-status" style="font-size: 13px; color: #666;"></div>
        </div>

        <!-- Breadcrumb navigation -->
        <div id="breadcrumb" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; display: none;">
          <span style="color: #666;">Path:</span>
          <span id="breadcrumb-path"></span>
        </div>

        <!-- File browser content -->
        <div id="file-browser-content">
          <p style="color: #666;">Select a path from the dropdown above to browse files on the agent</p>
        </div>

        <!-- Upload dialog (hidden by default) -->
        <div id="upload-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-top: 0;">Upload File</h3>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px;">Destination Path:</label>
              <input type="text" id="upload-path" class="form-control" readonly style="background: #e9ecef;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px;">Select File:</label>
              <input type="file" id="upload-file-input" class="form-control">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn" onclick="hideUploadDialog()">Cancel</button>
              <button class="btn" onclick="performUpload()" style="background: #007bff; color: white;">Upload</button>
            </div>
            <div id="upload-progress" style="margin-top: 15px; display: none;">
              <div style="background: #e9ecef; border-radius: 4px; overflow: hidden;">
                <div id="upload-progress-bar" style="background: #007bff; height: 30px; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Create folder dialog (hidden by default) -->
        <div id="create-folder-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 style="margin-top: 0;">Create Folder</h3>
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px;">Parent Path:</label>
              <input type="text" id="create-folder-parent" class="form-control" readonly style="background: #e9ecef;">
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px;">Folder Name:</label>
              <input type="text" id="create-folder-name" class="form-control" placeholder="New Folder">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button class="btn" onclick="hideCreateFolderDialog()">Cancel</button>
              <button class="btn" onclick="performCreateFolder()" style="background: #007bff; color: white;">Create</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="/js/agent-details.js"></script>
</body>
</html>
