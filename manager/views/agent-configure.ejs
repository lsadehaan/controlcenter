<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/css/agent-configure.css">
</head>
<body data-agent-config='<%- JSON.stringify(agent) %>'>
  <%- include('partials/nav') %>
  
  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h2>Configure Agent</h2>
        <a href="/agents/<%= agent.id %>" class="btn">Back to Agent</a>
      </div>
      
      <form class="config-form" id="config-form">
        <div class="form-section">
          <h3>Basic Settings</h3>
          <div class="form-group">
            <label>Agent ID</label>
            <input type="text" class="form-input" value="<%= agent.id %>" disabled>
          </div>
          <div class="form-group">
            <label>Hostname</label>
            <input type="text" class="form-input" value="<%= agent.metadata?.hostname || '' %>" disabled>
          </div>
        </div>
        
        <div class="form-section">
          <h3>SSH Server Configuration</h3>
          <div class="form-group">
            <label>SSH Server Port</label>
            <input type="number" id="sshServerPort" class="form-input" 
                   value="<%= agent.config.sshServerPort || 2222 %>" min="1" max="65535">
          </div>
          <div class="form-group">
            <label>Authorized SSH Keys</label>
            <div id="ssh-keys" class="ssh-key-list">
              <% const authorizedKeys = agent.config.authorizedSSHKeys || []; %>
              <% if (authorizedKeys.length === 0) { %>
                <p style="color: #999;">No authorized keys configured</p>
              <% } else { %>
                <% authorizedKeys.forEach((key, index) => { %>
                  <div class="ssh-key-item">
                    <input type="text" class="form-input" value="<%= key %>" data-index="<%= index %>">
                    <button type="button" class="btn btn-sm btn-danger remove-ssh-key-btn" data-index="<%= index %>">Remove</button>
                  </div>
                <% }) %>
              <% } %>
            </div>
            <button type="button" class="btn btn-sm add-key-btn" id="add-ssh-key-btn">Add SSH Key</button>
          </div>
        </div>
        
        <div class="form-section">
          <h3>Deployed Workflows</h3>
          <% const workflows = agent.config.workflows || []; %>
          <% if (workflows.length === 0) { %>
            <p style="color: #999;">No workflows deployed to this agent</p>
          <% } else { %>
            <ul class="workflow-list">
              <% workflows.forEach(workflow => { %>
                <li class="workflow-item">
                  <div>
                    <strong><%= workflow.name %></strong>
                    <span style="color: #666; margin-left: 10px;">ID: <%= workflow.id %></span>
                  </div>
                  <button type="button" class="btn btn-sm btn-danger remove-workflow-btn"
                          data-workflow-id="<%= workflow.id %>">Remove</button>
                </li>
              <% }) %>
            </ul>
          <% } %>
          <a href="/workflows" class="btn btn-sm">Deploy Workflows</a>
        </div>
        
        <div class="form-section">
          <h3>File Browser Settings</h3>
          <div class="form-group">
            <label>
              <input type="checkbox" id="fileBrowserEnabled"
                     <% if (agent.config.fileBrowserSettings?.enabled) { %>checked<% } %>>
              Enable File Browser
            </label>
            <p style="color: #666; font-size: 13px; margin-top: 5px;">
              Allows browsing, downloading, and uploading files on this agent through the manager UI.
            </p>
          </div>
          <div class="form-group">
            <label>Allowed Paths</label>
            <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
              Whitelist of directories accessible via file browser. If empty, defaults to agent data directory only.
            </p>
            <div id="allowed-paths" class="ssh-key-list">
              <% const allowedPaths = agent.config.fileBrowserSettings?.allowedPaths || []; %>
              <% if (allowedPaths.length === 0) { %>
                <p style="color: #999;">No paths configured (agent data directory only)</p>
              <% } else { %>
                <% allowedPaths.forEach((path, index) => { %>
                  <div class="ssh-key-item">
                    <input type="text" class="form-input" value="<%= path %>" data-path-index="<%= index %>">
                    <button type="button" class="btn btn-sm btn-danger remove-path-btn" data-path-index="<%= index %>">Remove</button>
                  </div>
                <% }) %>
              <% } %>
            </div>
            <button type="button" class="btn btn-sm add-key-btn" id="add-path-btn">Add Path</button>
          </div>
          <div class="form-group">
            <label>Max Upload Size (bytes)</label>
            <input type="number" id="maxUploadSize" class="form-input"
                   value="<%= agent.config.fileBrowserSettings?.maxUploadSize || 104857600 %>"
                   min="1" placeholder="104857600">
            <p style="color: #666; font-size: 13px; margin-top: 5px;">
              Default: 104857600 (100MB)
            </p>
          </div>
          <div class="form-group">
            <label>Max List Items</label>
            <input type="number" id="maxListItems" class="form-input"
                   value="<%= agent.config.fileBrowserSettings?.maxListItems || 1000 %>"
                   min="1" placeholder="1000">
            <p style="color: #666; font-size: 13px; margin-top: 5px;">
              Maximum number of files/folders to show per directory. Default: 1000
            </p>
          </div>
        </div>

        <div class="form-section">
          <h3>Advanced Configuration</h3>
          <div class="form-group">
            <label>Config Repository Path</label>
            <input type="text" id="configRepoPath" class="form-input"
                   value="<%= agent.config.configRepoPath || '' %>"
                   placeholder="e.g., /path/to/config/repo">
          </div>
          <div class="form-group">
            <label>Custom Configuration (JSON)</label>
            <textarea id="customConfig" class="form-input"
                      placeholder='{"key": "value"}'><%- JSON.stringify(agent.config.custom || {}, null, 2) %></textarea>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Configuration</button>
          <a href="/agents/<%= agent.id %>" class="btn">Cancel</a>
        </div>
      </form>
    </div>
  </main>

  <script src="/js/agent-configure.js"></script>
</body>
</html>
